<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelly Konfigurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border-color: rgba(0, 0, 0, 0.1);
            border-left-color: #1c7ed6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-success { background-color: #d1fae5; color: #065f46; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .status-info { background-color: #dbeafe; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 font-sans">
    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold text-blue-600 mb-2 border-b-2 border-blue-600 pb-2">Shelly Konfigurator</h1>
        <span class="text-sm font-mono text-gray-500">v{{ version }}</span>
        <p class="text-gray-600 mb-6">Ein Tool, um deine Shelly-Geräte in ein neues WLAN-Netzwerk zu integrieren.</p>

        <!-- Modus-Umschalter -->
        <div class="flex space-x-4 mb-6">
            <button id="mode-setup-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Einrichtungsmodus
            </button>
            <button id="mode-configure-button" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                Änderungsmodus
            </button>
        </div>

        <!-- PIN-Eingabe für Einrichtungsmodus -->
        <div id="pin-input-container" class="hidden bg-gray-50 border border-gray-200 rounded-md p-4 mb-6">
            <h2 class="text-xl font-semibold text-blue-500 mb-4">PIN eingeben</h2>
            <p class="text-gray-700 mb-4">Bitte gib den PIN ein, um den Einrichtungsmodus zu starten.</p>
            <input type="password" id="pin-input" placeholder="PIN" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-3 py-2">
            <button id="pin-submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition duration-300">
                Bestätigen
            </button>
            <p id="pin-error" class="text-red-600 mt-2 hidden">Falscher PIN.</p>
        </div>

        <!-- Einrichtungsmodus-Ansicht -->
        <div id="setup-mode" class="hidden bg-gray-50 border border-gray-200 rounded-md p-4 mb-6">
            <h2 class="text-xl font-semibold text-blue-500 mb-4">1. Geräte für Konfiguration auswählen</h2>
            <p class="text-gray-700 mb-4">Alle Shelly-WLANs sind automatisch vorausgewählt. Du kannst weitere Geräte manuell hinzufügen.</p>
            <button id="scan-button" onclick="scanAndLoadDevices()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                WLAN-Geräte suchen
            </button>
            <button id="save-button" onclick="saveSelectedDevices()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Auswahl speichern
            </button>
            <div id="scan-spinner" class="spinner w-6 h-6 rounded-full border-4 mt-4 hidden"></div>
            <div id="scan-status" class="mt-4 p-3 rounded-md hidden"></div>

            <ul id="setup-device-list" class="space-y-2 mt-4">
                <li class="text-gray-500">Keine Geräte gefunden. Starte einen Scan.</li>
            </ul>
        </div>

        <!-- Änderungsmodus-Ansicht -->
        <div id="configure-mode" class="hidden bg-gray-50 border border-gray-200 rounded-md p-4">
            <h2 class="text-xl font-semibold text-blue-500 mb-4">2. WLAN-Zugangsdaten angeben</h2>
            <p class="text-gray-700 mb-4">Diese Zugangsdaten werden auf alle gespeicherten Shelly-Geräte angewendet.</p>
            <label for="personal-ssid" class="block text-sm font-medium text-gray-700">WLAN-SSID:</label>
            <input type="text" id="personal-ssid" name="personal_ssid" placeholder="Dein WLAN-Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-3 py-2">
            <label for="personal-password" class="block text-sm font-medium text-gray-700 mt-4">WLAN-Passwort:</label>
            <input type="password" id="personal-password" name="personal_password" placeholder="Dein Passwort" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-3 py-2">
            <button id="configure-button" onclick="configureDevices()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition duration-300">
                Konfiguration starten
            </button>
            <div id="configure-spinner" class="spinner w-6 h-6 rounded-full border-4 mt-4 hidden"></div>
            <div id="configure-status" class="mt-4 p-3 rounded-md hidden"></div>
        </div>
    </div>
    
    <script>
        const setupModeDiv = document.getElementById('setup-mode');
        const configureModeDiv = document.getElementById('configure-mode');
        const setupButton = document.getElementById('mode-setup-button');
        const configureButton = document.getElementById('mode-configure-button');
        const pinInputContainer = document.getElementById('pin-input-container');
        const pinInput = document.getElementById('pin-input');
        const pinSubmitButton = document.getElementById('pin-submit-button');
        const pinError = document.getElementById('pin-error');
        const CORRECT_PIN = "0711";

        setupButton.addEventListener('click', () => {
            configureModeDiv.classList.add('hidden');
            setupModeDiv.classList.add('hidden');
            pinInputContainer.classList.remove('hidden');
            pinError.classList.add('hidden');
            pinInput.value = '';
            
            setupButton.classList.replace('bg-gray-300', 'bg-blue-600');
            setupButton.classList.replace('text-gray-800', 'text-white');
            configureButton.classList.replace('bg-blue-600', 'bg-gray-300');
            configureButton.classList.replace('text-white', 'text-gray-800');
        });

        pinSubmitButton.addEventListener('click', () => {
            if (pinInput.value === CORRECT_PIN) {
                pinInputContainer.classList.add('hidden');
                setupModeDiv.classList.remove('hidden');
                loadSavedDevicesForSetup();
            } else {
                pinError.classList.remove('hidden');
            }
        });

        configureButton.addEventListener('click', () => {
            setupModeDiv.classList.add('hidden');
            pinInputContainer.classList.add('hidden');
            configureModeDiv.classList.remove('hidden');
            
            configureButton.classList.replace('bg-gray-300', 'bg-blue-600');
            configureButton.classList.replace('text-gray-800', 'text-white');
            setupButton.classList.replace('bg-blue-600', 'bg-gray-300');
            setupButton.classList.replace('text-white', 'text-gray-800');
        });

        document.addEventListener('DOMContentLoaded', () => {
            setupButton.click();
        });

        // panel.html
        async function scanAndLoadDevices() {
            const scanButton = document.getElementById('scan-button');
            const saveButton = document.getElementById('save-button');
            const spinner = document.getElementById('scan-spinner');
            const statusDiv = document.getElementById('scan-status');

            scanButton.disabled = true;
            saveButton.disabled = true;
            spinner.classList.remove('hidden');
            statusDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/hassio_ingress/2b7875d4_shelly_config_tool/api/setup/scan', { method: 'POST' });

                if (!response.ok) {
                    const errorText = await response.text();
                    updateStatus('scan-status', `Netzwerkfehler: ${errorText}`, 'error');
                    return;
                }

                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        displaySetupDevices(result.data);
                        updateStatus('scan-status', `Scan erfolgreich. ${result.data.length} Geräte gefunden.`, 'success');
                    } else {
                        updateStatus('scan-status', `Fehler beim Scan: ${result.message}`, 'error');
                    }
                } else {
                    const errorText = await response.text();
                    updateStatus('scan-status', `Unerwartete Antwort vom Server: ${errorText}`, 'error');
                }

            } catch (error) {
                updateStatus('scan-status', `Fehler beim Senden der Anfrage: ${error}`, 'error');
            } finally {
                scanButton.disabled = false;
                saveButton.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        function displaySetupDevices(devices) {
            const list = document.getElementById('setup-device-list');
            list.innerHTML = '';
            
            if (devices.length === 0) {
                list.innerHTML = `<li class="text-gray-500">Keine Geräte gefunden. Starte einen Scan.</li>`;
                return;
            }

            devices.forEach(device => {
                const li = document.createElement('li');
                li.className = 'flex items-center space-x-4 p-3 bg-white rounded-md shadow-sm hover:shadow transition-shadow';
                li.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" ${device.selected ? 'checked' : ''} data-bssid="${device.bssid}">
                    <div class="flex-grow">
                        <strong class="text-blue-700">${device.ssid}</strong> <span class="text-gray-500 text-sm">(Signal: ${device.signal}%)</span><br>
                        <span class="text-gray-600 text-sm">BSSID: ${device.bssid}</span>
                    </div>
                    <input type="text" value="${device.description}" placeholder="Beschreibung hinzufügen" class="flex-shrink-0 w-1/3 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                `;
                list.appendChild(li);
            });
        }
        
        async function loadSavedDevicesForSetup() {
            try {
                const response = await fetch('/api/hassio_ingress/2b7875d4_shelly_config_tool/api/configure/get_saved_devices');
                const result = await response.json();
                displaySetupDevices(result.data);
            } catch (error) {
                console.error('Fehler beim Laden der gespeicherten Geräte:', error);
            }
        }
        
        async function saveSelectedDevices() {
            const checkboxes = document.querySelectorAll('#setup-device-list input[type="checkbox"]');
            const devices = [];
            checkboxes.forEach(checkbox => {
                const bssid = checkbox.getAttribute('data-bssid');
                const description = document.querySelector(`input[data-bssid="${bssid}"][type="text"]`).value;
                devices.push({
                    bssid: bssid,
                    description: description,
                    selected: checkbox.checked
                });
            });
            
            try {
                const response = await fetch('/api/hassio_ingress/2b7875d4_shelly_config_tool/api/setup/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ devices: devices })
                });
                const result = await response.json();
                updateStatus('scan-status', result.message, 'success');
            } catch (error) {
                updateStatus('scan-status', `Fehler beim Speichern: ${error}`, 'error');
            }
        }

        // Änderungsmodus Funktionen
        async function configureDevices() {
            const configureButton = document.getElementById('configure-button');
            const spinner = document.getElementById('configure-spinner');
            const ssidInput = document.getElementById('personal-ssid');
            const passwordInput = document.getElementById('personal-password');
            const statusDiv = document.getElementById('configure-status');

            if (!ssidInput.value || !passwordInput.value) {
                updateStatus('configure-status', 'Bitte gib WLAN-SSID und Passwort ein.', 'error');
                return;
            }

            configureButton.disabled = true;
            spinner.classList.remove('hidden');
            statusDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/hassio_ingress/2b7875d4_shelly_config_tool/api/configure/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ssid: ssidInput.value, password: passwordInput.value })
                });
                const results = await response.json();
                
                updateStatusFromBackend(results);
                
            } catch (error) {
                updateStatus('configure-status', `Kritischer Fehler bei der Konfiguration: ${error}`, 'error');
            } finally {
                configureButton.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        function updateStatusFromBackend(messages) {
            const statusDiv = document.getElementById('configure-status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '';
            
            messages.forEach(msg => {
                const p = document.createElement('p');
                p.textContent = msg.message;
                if (msg.type === 'success') {
                    p.className = 'text-green-800 font-semibold';
                } else if (msg.type === 'error') {
                    p.className = 'text-red-800 font-semibold';
                } else {
                    p.className = 'text-blue-800';
                }
                statusDiv.appendChild(p);
            });
        }
        
        function updateStatus(id, message, type) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.className = `mt-4 p-3 rounded-md status-message`;
            
            if (type === 'success') {
                element.classList.add('status-success');
            } else if (type === 'error') {
                element.classList.add('status-error');
            } else if (type === 'info') {
                 element.classList.add('status-info');
            }
            element.classList.remove('hidden');
        }
    </script>
</body>
</html>
